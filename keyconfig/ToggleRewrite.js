window._rwHackerStack = window._rwHackerStack || /\bhackerrank\.com\b|\/posts\/\d+\/comments/;
window._rwGAE = window._rwGAE || /\bappengine\.google\.com\/(css|js)/;
window._rwGoogleDev = window._rwGoogleDev || /\b(cloud|developers)\.google\.com\/_static\//;
window._rwMDN = window._rwMDN || /developer\.cdn\.mozilla\.net\/static\//;
window._rwGoogleIssues = window._rwGoogleIssues || /issuetracker\.google\.com\/.+\.(css|js)?/;
window._rwBlogger = window._rwBlogger || /www\.blogger\.com\/dyn-css\//;
window._rwGAS = window._rwGAS || /script\.google\.com\/macros\/.+\.js/;
window._rwSpring = window._rwSpring || /spring\.io\/.+\.(js|css)/;
window._rwImgSrch = window._rwImgSrch || /www\.google\.[a-z]*\/async\/imgrc\?/;
window._rwReddit = window._rwReddit || /redditstatic\.com\//;
window._rwMozMedia = window._rwMozMedia || /mozilla\.org\/media\//;
window._rwCSSJSPNG = window._rwCSSJSPNG || /\b(js|css|png)\b/;
window._rwCSSJSIgnore = window._rwCSSJSIgnore || /\/xjs\/_\/js\//;
window._rwCustomReq = window._rwCustomReq || /\/users\/codeheart\/requests\?/;
window._rwParams = window._rwParams || /\b(date|version|timestamp|buildTime|build-number|build|tseed|ver|cx|_v|_t|v|t|_|r|b|u|q)\b=[-a-z_0-9.:]+&?|\?_?[a-z_0-9]+$/g;

window._search = window._search || {};
window._replace = window._replace || {};

url5r = 'https://assetsv2.fiverrcdn.com/';
window._search[url5r] = window._search[url5r] || [
/\/conversations-\w{32}\.css/,
/\/conversations-\w{32}\.js/,
/\/jquery\.uploadifive-\w{32}\.js/,
/\/application-\w{32}\.js/,
/\/application-\w{32}\.css/,
/\/application-deferred-\w{32}\.css/,
/\/application-dependencies-\w{32}\.js/,
/\/application-legacy-\w{32}\.js/,
/\/orders-\w{32}\.css/,
/\/orders-\w{32}\.js/,
/\/reconnecting\.websocket-\w{32}\.js/,
/\/global-gig-listings-\w{32}\.js/,
/\/global-gig-listings-\w{32}\.css/,
/\/marketplace-\w{32}\.css/,
/\/user-dashboard-\w{32}\.css/,
/\/jquery\.inline-alert-\w{32}\.js/,
/\/todos-\w{32}\.js/,
/\/page-filter-actions-\w{32}\.css/,
/\/react-quick_responses-\w{32}\.css/,
/\/react-quick_responses-\w{32}\.js/,
/\/react-attachment_preview-\w{32}\.css/,
/\/polyfills-\w{32}\.js/,
/\/instantImpressions-\w{32}\.js/,
/\/jquery-2.1.4.min-\w{32}\.js/,
/\/translations.en-\w{32}\.js/,
/\/emoji-helper-\w{32}\.js/,
/\/popup-report-message-\w{32}\.js/,
/\/popup-report-message-\w{32}\.css/,
/\/footer-\w{32}\.css/,
/\/help-menu-\w{32}\.css/,
/\/fHelpMenu-\w{32}\.js/,
/\/appboy.min-\w{32}\.css/,
/\/appboy.min-\w{32}\.js/,
/\/notification-drawer-\w{32}\.css/,
/\/notification-drawer-\w{32}\.js/,
/\/appboy-overrides-\w{32}\.css/,
/\/tab-manager-\w{32}\.js/,
/\/fiverr-realtime-\w{32}\.css/,
/\/fRealTime-\w{32}\.js/,
/\/requests-\w{32}\.js/,
/\/offers-shared-\w{32}\.css/,
/\/offers-shared-\w{32}\.js/,
/\/react-order_notes_show-\w{32}\.css/,
/\/react-order_notes_show-\w{32}\.js/,
/\/global-social-sharing-\w{32}\.js/,
/\/popup-base-\w{32}\.js/,
/\/global-gig-cards-\w{32}\.css/,
/\/react-inbox-\w{32}\.css/,
/\/react-inbox-\w{32}\.js/,
/\/todos-\w{32}\.js/,
/\/popup-order-social-share-\w{32}\.js/,
/\/orders-share-deliveries-\w{32}\.js/,
/\/manage_gigs-\w{32}\.js/,
/\/passable-\w{32}\.js/,
/\/react-seller_profile_form_thin-\w{32}\.css/,
/\/react-seller_profile_form_thin-\w{32}\.js/,
/\/users-\w{32}\.css/,
/\/users-\w{32}\.js/,
];

urlBb = 'https://d301sr5gafysq2.cloudfront.net/';
window._search[urlBb] = window._search[urlBb] || [
/\/css\/entry\/vendor\.css/,
/\/css\/entry\/app\.css/,
/\/css\/entry\/adg3\.css/,
/\/dist\/webpack\/app\.js/,
/\/dist\/webpack\/vendor\.js/,
/\/dist\/webpack\/sentry\.js/,
/\/dist\/webpack\/early\.js/,
/\/dist\/webpack\/common\.js/,
/\/dist\/webpack\/pullrequests\.js/,
/\/dist\/webpack\/1\.chunk\.js/,
/\/dist\/webpack\/word-diff-worker\.js/,
/\/dist\/webpack\/locales\/en\.js/,
/\/jsi18n\/en\/djangojs\.js/
];

urlPPal = 'https://www.paypalobjects.com/';
window._search[urlPPal] = window._search[urlPPal] || [
/\/web\/res\/\w{3}\/\w{29}\/css\/contextualLogin\.css/,
/\/auth\/createchallenge\/\w{16}\/challenge.js/,
/\/js\/lib\/tealeaf-ul-prod_domcap\.min\.js/,
/\/css\/app\.ltr\.css/,
/\/css\/paypal-sans\.css/,
/\/css\/summary\.ltr\.css/,
/\/js\/apps\/app\.js/,
/\/js\/apps\/3\.3\.js/,
/\/widgets\/ajaxError\.js/,
/\/dust-templates\.js/,
/\/languagepack\.js/,
/\/widgets\/overpanel\.js/,
/\/summary\/inc\/fiModule\/fiList\.js/,
/\/activity\/transactionItemSimple\.js/,
/\/txndetails\/modules\.js/,
/\/txndetails\/inc\/layout\.js/,
/\/css\/wallet\.ltr\.css/,
/\/js\/apps\/1\.1\.js/,
/\/eboxapps\/css\/\w{2}\//,
/\/eboxapps\/css\/\w{2}\//,
/\/eboxapps\/css\/\w{2}\//,
/\/eboxapps\/js\/\w{2}\//,
/\/css\/app-service-nav\.ltr\.css/,
/\/js\/index\.js/,
];

urlPPAuth = 'https://www.paypal.com/auth/createchallenge/';
window._search[urlPPAuth] = window._search[urlPPAuth] || [/challenge\.js/];

urlTrello = 'https://a.trellocdn.com/';
window._search[urlTrello] = window._search[urlTrello] || [
/\/snowplow\.js/,
/\/quickload\.js/,
/\/ltp\.js/,
/\/locale\.en-US\.js/,
/\/app\.js/,
/\/core\.css/,
/\/images\.css/,
/*
https://trello.com/1/boards/58c182fa6a2274fdeeff4ff3/plugins
https://rules.quantcount.com/rules-p-9tnwrxnK1azF1.js
https://bello.atlassian.io/index.6bd8e18b3a5707deeb51.js
https://cdn.segment.com/analytics.js/v1/8Sa7pJhJNl2oAwmmg0bs5LotU31HtsmE/analytics.min.js
*/
];

urlSlack = 'https://a.slack-edge.com/';
window._search[urlSlack] = window._search[urlSlack] || [
/\/bv1-1\/webpack\.manifest\.\w{20}\.min\.js/,
/\/cd169\/style\/rollup-plastic\.css/,
/\/b003\/style\/libs\/lato-2-compressed\.css/,
/\/7cf62\/style\/_helpers\.css/,
/\/bv1-1\/emoji\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-core_required_libs\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-core_required_ts\.\w{20}\.min\.js/,
/\/bv1-1\/handlebars_4010\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.web\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-core_web\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-secondary_a_required\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-secondary_b_required\.\w{20}\.min\.js/,
/\/bv1-1\/application\.\w{20}\.min\.js/,
/\/bv1-1\/slack_beacon\.\w{20}\.min\.js/,
/\/style\/rollup-client_core\.css/,
/\/style\/rollup-client_primary\.css/,
/\/style\/typography\.css/,
/\/style\/rollup-client_general\.css/,
/\/style\/rollup-client_secondary\.css/,
/\/style\/rollup-client_base\.css/,
/\/style\/date_picker\.css/,
/\/style\/libs\/quill\.core\.css/,
/\/style\/texty\.css/,
/\/style\/libs\/lato-2-compressed\.css/,
/\/bv1-1\/webpack\.manifest\.\w{20}\.min\.js/,
/\/bv1-1\/bootstrap-client\.\w{20}\.min\.js/,
/\/bv1-1\/emoji\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-core_required_libs\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-core_required_ts\.\w{20}\.min\.js/,
/\/bv1-1\/handlebars_4010\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-client\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.highlights_briefing\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.utility\.window\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.files\.gdrive\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.files\.onedrive\.\w{20}\.min\.js/,
/\/bv1-1\/TS\.ui\.current_status_input\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-secondary_a_required\.\w{20}\.min\.js/,
/\/bv1-1\/rollup-secondary_b_required\.\w{20}\.min\.js/,
/\/bv1-1\/application\.\w{20}\.min\.js/,
/\/bv1-1\/slack_beacon\.\w{20}\.min\.js/,
/\/bv1-1\/focus-ring\.\w{20}\.min\.js/,
/\/bv1-1\/lz-string-[\d.]+\.worker\.\w{20,}\.js/,
/\/bv1-1\/TS\.client\.ui\.channel_insights\.\w{20}\.min\.js/,
/\/style\/rollup-slack_kit_legacy_adapters\.css/,
];

urleBayDev = '://ir.ebaystatic.com/rs/c/';
window._search[urleBayDev] = window._search[urleBayDev] || [
[/hello-\w{6}\.css/, 2],
[/reset-\w{6}\.css/, 2],
[/fyp-\w{6}\.css/, 2],
[/auth-\w{6}\.css/, 2],
[/keys-\w{6}\.css/, 2],
[/profile-\w{6}\.css/, 2],
/hello-\w{6}\.js/,
/reset-\w{6}\.js/,
/fyp-\w{6}\.js/,
/auth-\w{6}\.js/,
/keys-\w{6}\.js/,
/profile-\w{6}\.js/,
];

urleBay = 'https://secureir.ebaystatic.com/rs/v/';
window._search[urleBay] = window._search[urleBay] || [
[/\w{27}\.css/, 5],
[/\w{27}\.js/, 7],
];

urlEBForum = '://forums.developer.ebay.com/';
window._search[urlEBForum] = window._search[urlEBForum] || [/\/css\/bootstrap\.min\.css/];

urlGH = 'https://assets-cdn.github.com/assets/';
window._search[urlGH] = window._search[urlGH] || [
/mobile-\w{64}\.css/,
/mobile-\w{64}\.js/,
/frameworks-\w{64}\.css/,
/frameworks-\w{64}\.js/,
/github-\w{64}\.css/,
/github-\w{64}\.js/,
/compat-\w{64}\.js/,
];

urlDZ1 = 'https://dz2cdn3.dzone.com/';
window._search[urlDZ1] = window._search[urlDZ1] || [[/-combined\.css/, 2]];
urlDZ2 = 'https://dz2cdn2.dzone.com/';
window._search[urlDZ2] = window._search[urlDZ2] || [[/-combined\.js/, 2]];

urlGAS = 'https://script.google.com/';
window._search[urlGAS] = window._search[urlGAS] || [
/\/client\/css\/\d+-MaestroIdeShellCss_ltr.css/,
/\/client\/js\/\d+-code_mirror_bin_code_mirror.js/,
/\/client\/js\/\d+-maestro_ide_shell_bin_i18n_maestro_ide_shell\.js/,
/\/gwt\/googleappsscripts\.nocache\.js/,
/\/sharing\/init/,
/\/gwt\/\w{32}\.cache\.js/,
];

urlGooJS = 'https://www.google.com/js/';
window._search[urlGooJS] = window._search[urlGooJS] || [
[/\/bg\/\w{43}\.js/, 2],
];

urlGAPI = 'https://apis.google.com/_/scs/abc-static/';
window._search[urlGAPI] = window._search[urlGAPI] || [
[/_\/js\/k=gapi\.gapi\.en\..*\/m=gapi_iframes,googleapis_client,plusone\/rt=j\/sv=1\/d=1\/ed=1\/rs=.*\/cb=gapi\.loaded_0/, 2],
/_\/js\/k=gapi\.gapi\.en\..*\/m=gapi_iframes,googleapis_client,iframes_styles_slide_menu,plusone\/rt=j\/sv=1\/d=1\/ed=1\/rs=.*\/cb=gapi\.loaded_0/,
];

urlMozBug = 'https://bugzilla.mozilla.org/data/assets/';
window._search[urlMozBug] = window._search[urlMozBug] || [
[/\w{32}\.css/, 2],
[/\w{32}\.js/, 4],
];

window._sanitizeUrl = window._sanitizeUrl || function(url, params) {
	if (!params) {
		params = url.match(_rwParams) || [];
	}
	params.map(function(v) {
		url = url.replace(v, '');
	});
	return url.endsWith('?') ? url.substring(0, url.length - 1) : url;
};

window.toggleRW = window.toggleRW || function() {
	toggleService.toggle('rw', function(channel) {
		url = channel.URI.spec;
		if (url.match(_toggleIgnore))
			return;
		if(url.match(_rwHackerStack))
			channel.URI.spec = url.replace(/&?_=\d+/, '').replace(/\?$/, '');
		else if(url.match(_rwGAE))
			channel.URI.spec = url.replace(/\d+\-[0-9a-z]+\.\d+\./, '');
		else if(url.match(_rwGoogleDev)) {
			pos = url.indexOf("/", url.indexOf("_static"));
			channel.URI.spec = url.substring(0, pos) + url.substring(url.indexOf("/", pos + 1));
		}
		else if(url.match(_rwMDN))
			channel.URI.spec = url.replace(/[0-9a-z]+\.js/, 'js').replace(/[0-9a-z]+\.css/, 'css');
		else if(url.match(_rwGoogleIssues))
			channel.URI.spec = url.substring(0, url.lastIndexOf('?'));
		else if(url.match(_rwBlogger))
			channel.URI.spec = url.substring(0, url.indexOf("?"));
/*		else if(url.match(_rwGAS))
			channel.URI.spec = url.replace(/d\/[^/]+\//, '');*/
		else if(url.match(_rwSpring))
			channel.URI.spec = url.replace(/-[a-z0-9]{32}\./, '.');
		else if(url.match(_rwImgSrch)) {
			csi = url.indexOf('&csi=');
			channel.URI.spec = (url.substring(0, csi) + url.substring(url.indexOf('&', csi + 1))).replace(/cidx:\d,_id:irc_imgrc\d,_pms:s/, "cidx:2,_id:irc_imgrc2,_pms:s");
		}
		else if(url.match(_rwReddit))
			channel.URI.spec = url.replace(/\.\S{11}\./, '.');
		else if(url.match(_rwMozMedia))
			channel.URI.spec = url.replace(/\.\S{12}\./, '.');

		else for(k in _search) if(url.indexOf(k) > -1) {
			s = _search[k];
			r = _replace[k] || (_replace[k] = []);
			for(i in s) {
				multi = s[i] instanceof Array;
				key = multi ? s[i][0] : s[i];
				if(url.match(key)) {
					if(r[i]) {
						if (!multi) {
							if (!rwOverwriteDown) {
								r[i] = _sanitizeUrl(channel.URI.spec);
							}
							channel.URI.spec = r[i];
							return;
						}
						s[i][2] = (++s[i][2] || 0) % s[i][1];
						if (r[i][s[i][2]]) {
							if (!rwOverwriteDown) {
								r[i][s[i][2]] = _sanitizeUrl(channel.URI.spec);
							}
							channel.URI.spec = r[i][s[i][2]];
						} else {
							r[i].push(_sanitizeUrl(url));
						}
					} else {
						url = _sanitizeUrl(url);
						r[i] = multi ? [url] : url;
					}
					return;
				}
			}
			return;
		}

		if((!url.match(_rwCSSJSPNG) || url.match(_rwCSSJSIgnore)) && !url.match(_rwCustomReq)) return;

		params = url.match(_rwParams);
		if(!params) return;
		channel.URI.spec = _sanitizeUrl(url, params);
	}, {
		title: "URL Rewriter On",
		body: "Chosen URLs will be remapped to cache."
	}, {
		title: "URL Rewriter Off",
		body: "Chosen URLs will load normally."
	});
};
toggleRW();
